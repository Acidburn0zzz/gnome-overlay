From 7dd4969b75616552e9123947f0d963bfcdbf6042 Mon Sep 17 00:00:00 2001
From: Gilles Dartiguelongue <eva@gentoo.org>
Date: Sun, 26 Apr 2009 22:21:50 +0200
Subject: [PATCH 2/3] Allow shutdown without gdm

 Gentoo: https://bugs.gentoo.org/show_bug.cgi?id=259138
---
 gnome-panel/panel-gdm.c    |   24 +++++++++++++++++++-----
 gnome-panel/panel-gdm.h    |    1 +
 gnome-panel/panel-logout.c |   10 ++++++----
 3 files changed, 26 insertions(+), 9 deletions(-)

diff --git a/gnome-panel/panel-gdm.c b/gnome-panel/panel-gdm.c
index cff45ea..93d578d 100644
--- a/gnome-panel/panel-gdm.c
+++ b/gnome-panel/panel-gdm.c
@@ -234,6 +234,15 @@ gdm_init_protocol_connection (GdmProtocolData *data)
 
         g_assert (data->fd <= 0);
 
+	if (g_file_test (GDM_PROTOCOL_SOCKET_PATH, G_FILE_TEST_EXISTS))
+	  strcpy (addr.sun_path, GDM_PROTOCOL_SOCKET_PATH);
+	else if (g_file_test ("/tmp/.gdm_socket", G_FILE_TEST_EXISTS))
+	  strcpy (addr.sun_path, "/tmp/.gdm_socket");
+	else {
+		gdm_shutdown_protocol_connection (data);
+		return FALSE;
+	}
+
         data->fd = socket (AF_UNIX, SOCK_STREAM, 0);
         if (data->fd < 0) {
                 g_warning ("Failed to create GDM socket: %s",
@@ -242,11 +251,6 @@ gdm_init_protocol_connection (GdmProtocolData *data)
                 return FALSE;
         }
 
-	if (g_file_test (GDM_PROTOCOL_SOCKET_PATH, G_FILE_TEST_EXISTS))
-	  strcpy (addr.sun_path, GDM_PROTOCOL_SOCKET_PATH);
-	else
-	  strcpy (addr.sun_path, "/tmp/.gdm_socket");
-
 	addr.sun_family = AF_UNIX;
 
         if (connect (data->fd, (struct sockaddr *) &addr, sizeof (addr)) < 0) {
@@ -398,6 +402,16 @@ gdm_set_logout_action (GdmLogoutAction action)
         gdm_shutdown_protocol_connection (&gdm_protocol_data);
 }
 
+gboolean
+gdm_available (void)
+{
+	if (!gdm_init_protocol_connection (&gdm_protocol_data))
+		return FALSE;
+
+	gdm_shutdown_protocol_connection (&gdm_protocol_data);
+	return TRUE;
+}
+
 void
 gdm_new_login (void)
 {
diff --git a/gnome-panel/panel-gdm.h b/gnome-panel/panel-gdm.h
index 78fe66d..3539d5c 100644
--- a/gnome-panel/panel-gdm.h
+++ b/gnome-panel/panel-gdm.h
@@ -46,6 +46,7 @@ gboolean gdm_supports_logout_action (GdmLogoutAction action);
 void            gdm_set_logout_action (GdmLogoutAction action);
 GdmLogoutAction gdm_get_logout_action (void);
 void            gdm_new_login         (void);
+gboolean        gdm_available         (void);
 
 G_END_DECLS
 
diff --git a/gnome-panel/panel-logout.c b/gnome-panel/panel-logout.c
index ca8a639..5b4beb2 100644
--- a/gnome-panel/panel-logout.c
+++ b/gnome-panel/panel-logout.c
@@ -341,10 +341,12 @@ panel_logout_new (PanelLogoutDialogType  type,
 		// FIXME need to verify that this response can be used
 		logout_dialog->priv->default_response = PANEL_LOGOUT_DIALOG_LOGOUT;
 
-		//FIXME is gdm running?
-		gtk_dialog_add_button (GTK_DIALOG (logout_dialog),
-				       _("_Switch User"),
-				       PANEL_LOGOUT_RESPONSE_SWITCH_USER);
+		//FIXME need to have a more flexible test for availability
+		if (gdm_available())
+			gtk_dialog_add_button (GTK_DIALOG (logout_dialog),
+					        _("_Switch User"),
+					        PANEL_LOGOUT_RESPONSE_SWITCH_USER);
+
 		gtk_dialog_add_button (GTK_DIALOG (logout_dialog),
 				       GTK_STOCK_CANCEL,
 				       GTK_RESPONSE_CANCEL);
-- 
1.6.5.rc1

