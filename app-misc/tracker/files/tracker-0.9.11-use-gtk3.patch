From 472fcf36b220dff3f01179678376b6a96cd373c2 Mon Sep 17 00:00:00 2001
From: Maciej Piechotka <uzytkownik2@gmail.com>
Date: Sat, 10 Jul 2010 14:38:40 +0200
Subject: [PATCH] Initial stage of Gtk+ 3.0 port.

---
 configure.ac                                     |   65 +++++++++++----
 src/plugins/evolution/Makefile.am                |    6 +-
 src/plugins/evolution/tracker-evolution-plugin.c |   96 ++++++++++++++++-----
 src/plugins/nautilus/Makefile.am                 |    4 +-
 src/tracker-preferences/Makefile.am              |    2 +
 src/tracker-search-bar/Makefile.am               |    2 +
 src/tracker-search-bar/tracker-aligned-window.c  |   12 ++--
 src/tracker-search-bar/tracker-applet.c          |    8 +-
 src/tracker-search-bar/tracker-results-window.c  |   22 +++--
 src/tracker-status-icon/Makefile.am              |    2 +
 src/tracker-writeback/Makefile.am                |    2 +
 11 files changed, 163 insertions(+), 58 deletions(-)

diff --git a/configure.ac b/configure.ac
index f3bb067..802829e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -130,28 +130,51 @@ if test "x$have_function" = "xno" ; then
             [Defined for compilers not supporting __FUNCTION__])
 fi
 
+AC_ARG_ENABLE([gtk3],
+	AS_HELP_STRING([--enable-gtk3],
+	[Attempt to use gtk+-3]),
+	[enable_gtk3=$enableval],[enable_gtk3=no])
+
+if test "x${enable_gtk3}" = "xyes"; then
+   GTK_VERSION="gtk+-3.0"
+   GTK_REQUIRED=2.90.4
+   GTK2_REQUIRED=2.21.4
+   GDK_VERSION="gdk-3.0"
+   GDK_REQUIRED=2.90.4
+   EVO_VERSION="evolution-plugin-3.0"
+   EVO_REQUIRED=2.31.4
+else
+   GTK_VERSION="gtk+-2.0"
+   GTK_REQUIRED=2.18.4
+   GTK2_REQUIRED=$GTK_REQUIRED
+   GDK_VERSION="gdk-2.0"
+   GDK_REQUIRED=1.0
+   EVO_VERSION="evolution-plugin"
+   EVO_REQUIRED=2.25.4
+fi
+
+AM_CONDITIONAL([GTK3], [test "x${enable_gtk3}" = "xyes"])
+
 # Library required versions
 DBUS_REQUIRED=1.0
 DBUS_GLIB_REQUIRED=0.78
 GLIB_REQUIRED=2.24.0
 PANGO_REQUIRED=1.0.0
-GTK_REQUIRED=2.18.0
 LIBXML2_REQUIRED=2.6
 LIBNOTIFY_REQUIRED=0.4.3
 HAL_REQUIRED=0.5
 UPOWER_REQUIRED=0.9.0
-GDKPIXBUF_REQUIRED=2.12.0
+GDKPIXBUF_REQUIRED=1.0
 QUILL_REQUIRED=1.0.0
 POPPLER_REQUIRED=0.12.2
 CAIRO_REQUIRED=1.0
-GDK_REQUIRED=1.0
+GDK_REQUIRED=2.90.4
 LIBVORBIS_REQUIRED=0.22
 LIBFLAC_REQUIRED=1.2.1
 LIBEXIF_REQUIRED=0.6
 LIBGSF_REQUIRED=1.13
 EXEMPI_REQUIRED=2.1.0
 HILDON_THUMBNAIL_REQUIRED=3.0.10
-EVO_REQUIRED=2.25.5
 EDS_REQUIRED=2.25.5
 # Unlikely version for now, Nepomuk integration isn't finished in streamanalyzer atm
 LIBSTREAMANALYZER_REQUIRED=0.7.0
@@ -897,7 +920,7 @@ AC_ARG_ENABLE([miner_evolution],
 
 if test "x$enable_miner_evolution" != "xno"; then
    PKG_CHECK_MODULES(EVOLUTION_PLUGIN,
-                     [evolution-plugin >= $EVO_REQUIRED
+                     [$EVO_VERSION >= $EVO_REQUIRED
                       evolution-data-server-1.2 >= $EDS_REQUIRED],
                      have_miner_evolution=yes,
                      have_miner_evolution=no)
@@ -914,7 +937,7 @@ if test "x$enable_miner_evolution" != "xno"; then
                   AS_HELP_STRING([--with-evolution-plugins-dir],
                                  [path to Evolution plugins directory]))
       if test "x$with_evolution_plugins_dir" = "x" ; then
-         evolution_plugins_dir=`$PKG_CONFIG evolution-plugin --variable=plugindir`
+         evolution_plugins_dir=`$PKG_CONFIG $EVO_VERSION --variable=plugindir`
       else
          evolution_plugins_dir="$with_evolution_plugins_dir"
       fi
@@ -986,16 +1009,16 @@ AM_CONDITIONAL(HAVE_MINER_RSS, test "x$have_miner_rss" = "xyes")
 # Application and Vala requirements
 ####################################################################
 
-APP_REQUIREMENTS="glib-2.0    >= $GLIB_REQUIRED
+APP_REQUIREMENTS="glib-2.0     >= $GLIB_REQUIRED
                   gio-unix-2.0 >= $GLIB_REQUIRED
-                  gthread-2.0 >= $GLIB_REQUIRED
-                  gmodule-2.0 >= $GLIB_REQUIRED
-                  gtk+-2.0    >= $GTK_REQUIRED
-                  dbus-1      >= $DBUS_REQUIRED
-                  dbus-glib-1 >= $DBUS_GLIB_REQUIRED"
+                  gthread-2.0  >= $GLIB_REQUIRED
+                  gmodule-2.0  >= $GLIB_REQUIRED
+                  dbus-1       >= $DBUS_REQUIRED
+                  dbus-glib-1  >= $DBUS_GLIB_REQUIRED"
 
 APPLET_REQUIREMENTS="libpanelapplet-2.0"
-VALA_REQUIREMENTS="gee-1.0 >= $GEE_REQUIRED"
+VALA_REQUIREMENTS="gee-1.0 >= $GEE_REQUIRED gtk+-2.0 >= $GTK2_REQUIRED"
+GTK_REQUIREMENTS="$GTK_VERSION >= $GTK_REQUIRED"
 
 PKG_CHECK_MODULES(TRACKER_APPS,
                   [ $APP_REQUIREMENTS ],
@@ -1005,6 +1028,15 @@ PKG_CHECK_MODULES(TRACKER_APPS,
 AC_SUBST(TRACKER_APPS_CFLAGS)
 AC_SUBST(TRACKER_APPS_LIBS)
 
+if test x$have_app_requirements = xyes; then
+	PKG_CHECK_MODULES(GTK,
+	                  [ $GTK_REQUIREMENTS ],
+	                  [have_gtk_requirements=yes],
+	                  [have_gtk_requirements=no])
+	AC_SUBST(GTK_CFLAGS)
+	AC_SUBST(GTK_LIBS)
+fi
+
 PKG_CHECK_MODULES(TRACKER_APPLETS,
                   [ $APPLET_REQUIREMENTS ],
                   [have_applet_requirements=yes],
@@ -1031,7 +1063,8 @@ AC_ARG_ENABLE([tracker-status-icon],
               [enable_tracker_status_icon=auto])
 
 if test "x$enable_tracker_status_icon" != "xno" ; then
-   if test "x$have_app_requirements" != "xyes"; then
+   if test "x$have_app_requirements" != "xyes" -o \
+           "x$have_gtk_requirements" != "xyes"; then
       have_tracker_status_icon="no"
    else
       have_tracker_status_icon="yes"
@@ -1099,6 +1132,7 @@ AC_ARG_ENABLE([tracker-search-bar],
 
 if test "x$enable_tracker_search_bar" != "xno" ; then
    if test "x$have_app_requirements" != "xyes" -o \
+           "x$have_gtk_requirements" != "xyes" -o \
            "x$have_applet_requirements" != "xyes"; then
       have_tracker_search_bar="no"
    else
@@ -1166,7 +1200,8 @@ AC_ARG_ENABLE([tracker-preferences],
               [enable_tracker_preferences=auto])
 
 if test "x$enable_tracker_preferences" != "xno" ; then
-   if test "x$have_app_requirements" != "xyes"; then
+   if test "x$have_app_requirements" != "xyes" -o \
+           "x$have_gtk_requirements" != "xyes"; then
       have_tracker_preferences="no"
    else
       have_tracker_preferences="yes"
diff --git a/src/plugins/evolution/Makefile.am b/src/plugins/evolution/Makefile.am
index 7db1433..03c10f1 100644
--- a/src/plugins/evolution/Makefile.am
+++ b/src/plugins/evolution/Makefile.am
@@ -35,7 +35,7 @@ liborg_freedesktop_Tracker_evolution_plugin_la_SOURCES = 		\
 	tracker-evolution-plugin.h
 
 liborg_freedesktop_Tracker_evolution_plugin_la_LDFLAGS = -module -avoid-version
-liborg_freedesktop_Tracker_evolution_plugin_la_LIBADD = 		\
+liborg_freedesktop_Tracker_evolution_plugin_la_LIBS = 		\
 	$(top_builddir)/src/libtracker-client/libtracker-client-@TRACKER_API_VERSION@.la \
 	$(top_builddir)/src/libtracker-miner/libtracker-miner-@TRACKER_API_VERSION@.la	\
 	$(top_builddir)/src/libtracker-common/libtracker-common.la	\
@@ -43,6 +43,10 @@ liborg_freedesktop_Tracker_evolution_plugin_la_LIBADD = 		\
 	$(DBUS_LIBS)							\
 	$(GCOV_LIBS)
 
+if GTK3
+liborg_freedesktop_Tracker_evolution_plugin_la_CFLAGS = -DGTK3
+endif
+
 @INTLTOOL_DESKTOP_RULE@
 
 %-glue.h: %.xml
diff --git a/src/plugins/evolution/tracker-evolution-plugin.c b/src/plugins/evolution/tracker-evolution-plugin.c
index 3cfbea8..5f1ced3 100644
--- a/src/plugins/evolution/tracker-evolution-plugin.c
+++ b/src/plugins/evolution/tracker-evolution-plugin.c
@@ -34,32 +34,13 @@
 #include <time.h>
 #include <inttypes.h>
 
+#include <glib/gi18n.h>
 #include <glib-object.h>
 #include <gio/gio.h>
 
 #include <sqlite3.h>
 
-#include <camel/camel-mime-message.h>
-#include <camel/camel-i18n.h>
-#include <camel/camel-store.h>
-#include <camel/camel-folder.h>
-#include <camel/camel-db.h>
-#include <camel/camel-offline-store.h>
-#include <camel/camel-session.h>
-#include <camel/camel-url.h>
-#include <camel/camel-stream.h>
-#include <camel/camel-stream-mem.h>
-#include <camel/camel-multipart.h>
-#include <camel/camel-multipart-encrypted.h>
-#include <camel/camel-multipart-signed.h>
-#include <camel/camel-medium.h>
-#include <camel/camel-gpg-context.h>
-#include <camel/camel-smime-context.h>
-#include <camel/camel-string-utils.h>
-#include <camel/camel-stream-filter.h>
-#include <camel/camel-stream-null.h>
-#include <camel/camel-mime-filter-charset.h>
-#include <camel/camel-mime-filter-windows.h>
+#include <camel/camel.h>
 
 #include <mail/mail-config.h>
 #include <mail/mail-session.h>
@@ -114,7 +95,11 @@ G_DEFINE_TYPE (TrackerEvolutionPlugin, tracker_evolution_plugin, TRACKER_TYPE_MI
  * the database) - guys, encoding things in fields of a table in a database is
  * cruel and prone to error. Anyway). */
 
+#ifdef GTK3
 #define CAMEL_CALLBACK(func) ((CamelObjectEventHookFunc) func)
+#else
+#define CAMEL_CALLBACK(func) ((GCallback) func)
+#endif
 #define EXTRACT_STRING(val) if (*part) part++; len=strtoul (part, &part, 10); if (*part) part++; val=g_strndup (part, len); part+=len;
 #define EXTRACT_FIRST_DIGIT(val) val=strtoul (part, &part, 10);
 
@@ -303,8 +288,13 @@ get_email_and_fullname (const gchar *line, gchar **email, gchar **fullname)
 static void
 folder_registry_free (FolderRegistry *registry)
 {
+#ifdef GTK3
+	g_signal_handler_disconnect (registry->folder, registry->hook_info->hook_id);
+	g_object_unref (registry->folder);
+#else
 	camel_object_remove_event (registry->folder, registry->hook_info->hook_id);
 	camel_object_unref (registry->folder);
+#endif
 	g_free (registry->hook_info->account_uri);
 	g_slice_free (OnSummaryChangedInfo, registry->hook_info);
 	g_slice_free (FolderRegistry, registry);
@@ -321,7 +311,11 @@ folder_registry_new (const gchar *account_uri,
 	registry->hook_info->account_uri = g_strdup (account_uri);
 	registry->hook_info->self = self; /* weak */
 	registry->hook_info->hook_id = 0;
+#ifdef GTK3
+	g_object_ref (folder);
+#else
 	camel_object_ref (folder);
+#endif
 	registry->folder = folder;
 
 	return registry;
@@ -1344,10 +1338,15 @@ register_on_get_folder (gchar *uri, CamelFolder *folder, gpointer user_data)
 	if (!priv->registered_folders || !priv->cached_folders) {
 		goto not_ready;
 	}
-
+#ifdef GTK3
+	hook_id = g_signal_connect (folder, "changed",
+	                            G_CALLBACK (on_folder_summary_changed),
+	                            registry->hook_info);
+#else
 	hook_id = camel_object_hook_event (folder, "folder_changed",
 	                                   CAMEL_CALLBACK (on_folder_summary_changed),
 	                                   registry->hook_info);
+#endif
 	registry->hook_info->hook_id = hook_id;
 
 	g_hash_table_replace (priv->registered_folders,
@@ -1524,7 +1523,11 @@ free_worker_thread_info (gpointer data, gpointer user_data)
 	/* Ownership was transfered to us in try_again */
 	free_introduction_info (winfo->intro_info);
 	camel_db_close (winfo->cdb_r);
+#ifdef GTK3
+	g_object_unref (winfo->store);
+#else
 	camel_object_unref (winfo->store);
+#endif
 	camel_folder_info_free (winfo->iter);
 	g_free (winfo);
 }
@@ -1579,7 +1582,11 @@ on_got_folderinfo_introduce (CamelStore *store,
 
 	/* Ownership of these is transfered in try_again */
 
+#ifdef GTK3
+	g_object_ref (store);
+#else
 	camel_object_ref (store);
+#endif
 	info->store = store;
 	/* This apparently creates a thread */
 	info->cdb_r = camel_db_clone (store->cdb_r, NULL);
@@ -1660,8 +1667,11 @@ introduce_account_to (TrackerEvolutionPlugin *self,
 
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_introduce, intro_info);
 
+#ifdef GTK3
+	g_object_unref (store);
+#else
 	camel_object_unref (store);
-
+#endif
 }
 
 
@@ -1821,7 +1831,12 @@ on_folder_deleted (CamelStore *store,
 
 static void
 on_folder_renamed (CamelStore *store,
+#ifdef GTK3
+                   gchar *arg1,
+                   gpointer arg2,
+#else
                    CamelRenameInfo *info,
+#endif
                    StoreRegistry *registry)
 {
 	unregister_account (registry->self, registry->account);
@@ -1839,7 +1854,11 @@ store_registry_new (gpointer co,
 	registry->store = co;
 	registry->account = account; /* weak */
 	registry->self = self; /* weak */
+#ifdef GTK3
+	g_object_ref (co);
+#else
 	camel_object_ref (co);
+#endif
 
 	return registry;
 }
@@ -1847,8 +1866,13 @@ store_registry_new (gpointer co,
 static void
 store_registry_free (StoreRegistry *registry)
 {
+#ifdef GTK3
+	g_signal_handler_disconnect (registry->store, registry->hook_id);
+	g_object_unref (registry->store);
+#else
 	camel_object_remove_event (registry->store, registry->hook_id);
 	camel_object_unref (registry->store);
+#endif
 	g_slice_free (StoreRegistry, registry);
 }
 
@@ -1876,27 +1900,45 @@ on_got_folderinfo_register (CamelStore *store,
 
 	/* Hook up catching folder changes in the store */
 	registry = store_registry_new (store, account, self);
+#ifdef GTK3
+	hook_id = g_signal_connect (store, "folder-created",
+	                            G_CALLBACK (on_folder_created),
+	                            registry);
+#else
 	hook_id = camel_object_hook_event (store, "folder_created",
 	                                   CAMEL_CALLBACK (on_folder_created),
 	                                   registry);
+#endif
 	registry->hook_id = hook_id;
 	g_hash_table_replace (priv->registered_stores,
 	                      GINT_TO_POINTER (hook_id),
 	                      registry);
 
 	registry = store_registry_new (store, account, self);
+#ifdef GTK3
+	hook_id = g_signal_connect (store, "folder-renamed",
+	                            G_CALLBACK (on_folder_renamed),
+	                            registry);
+#else
 	hook_id = camel_object_hook_event (store, "folder_renamed",
 	                                   CAMEL_CALLBACK (on_folder_renamed),
 	                                   registry);
+#endif
 	registry->hook_id = hook_id;
 	g_hash_table_replace (priv->registered_stores,
 	                      GINT_TO_POINTER (hook_id),
 	                      registry);
 
 	registry = store_registry_new (store, account, self);
+#ifdef GTK3
+	hook_id = g_signal_connect (store, "folder-deleted",
+	                            G_CALLBACK (on_folder_deleted),
+	                            registry);
+#else
 	hook_id = camel_object_hook_event (store, "folder_deleted",
 	                                   CAMEL_CALLBACK (on_folder_deleted),
 	                                   registry);
+#endif
 	registry->hook_id = hook_id;
 	g_hash_table_replace (priv->registered_stores,
 	                      GINT_TO_POINTER (hook_id),
@@ -1953,7 +1995,11 @@ register_account (TrackerEvolutionPlugin *self,
 	/* Get the account's folder-info and register it asynchronously */
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_register, reg_info);
 
+#ifdef GTK3
+	g_object_unref (store);
+#else
 	camel_object_unref (store);
+#endif
 }
 
 static gboolean
@@ -2020,7 +2066,11 @@ unregister_account (TrackerEvolutionPlugin *self,
 	/* Get the account's folder-info and unregister asynchronously */
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_unregister, reg_info);
 
+#ifdef GTK3
+	g_object_unref (store);
+#else
 	camel_object_unref (store);
+#endif
 }
 
 static void
diff --git a/src/plugins/nautilus/Makefile.am b/src/plugins/nautilus/Makefile.am
index 566ad5e..8715c66 100644
--- a/src/plugins/nautilus/Makefile.am
+++ b/src/plugins/nautilus/Makefile.am
@@ -8,6 +8,7 @@ INCLUDES =											\
 	$(WARN_CFLAGS)										\
 	$(NAUTILUS_EXTENSION_CFLAGS)								\
 	$(TRACKER_APPS_CFLAGS)									\
+	$(GTK_CFLAGS)										\
 	$(DBUS_CFLAGS)
 
 nautilus_extensiondir = $(NAUTILUS_EXTENSION_INSTALL_DIR)
@@ -26,4 +27,5 @@ libnautilus_tracker_tags_la_LIBADD =								\
 	$(top_builddir)/src/libtracker-client/libtracker-client-@TRACKER_API_VERSION@.la	\
 	$(GCOV_LIBS)										\
 	$(NAUTILUS_EXTENSION_LIBS)								\
-	$(TRACKER_APPS_LIBS)
+	$(TRACKER_APPS_LIBS)									\
+	$(GTK_CFLAGS)
diff --git a/src/tracker-preferences/Makefile.am b/src/tracker-preferences/Makefile.am
index 585b4a8..60ef41a 100644
--- a/src/tracker-preferences/Makefile.am
+++ b/src/tracker-preferences/Makefile.am
@@ -19,6 +19,7 @@ INCLUDES = 								\
 	-I$(top_srcdir)/src						\
 	-I$(top_builddir)						\
 	$(TRACKER_APPS_CFLAGS)						\
+	$(GTK_CFLAGS)							\
 	$(WARN_CFLAGS)							\
 	$(GCOV_CFLAGS)
 
@@ -41,6 +42,7 @@ tracker_preferences_LDADD = 						\
 	$(top_builddir)/src/libtracker-client/libtracker-client-@TRACKER_API_VERSION@.la	\
 	$(top_builddir)/src/libtracker-common/libtracker-common.la 	\
 	$(TRACKER_APPS_LIBS)						\
+	$(GTK_LIBS)							\
 	$(GCOV_LIBS)
 
 MAINTAINERCLEANFILES =							\
diff --git a/src/tracker-search-bar/Makefile.am b/src/tracker-search-bar/Makefile.am
index aea47c0..273b0b7 100644
--- a/src/tracker-search-bar/Makefile.am
+++ b/src/tracker-search-bar/Makefile.am
@@ -19,6 +19,7 @@ tracker_search_bar_CFLAGS = \
 	-I$(top_builddir)/src					\
 	-I$(top_builddir)/src/libtracker-client			\
 	$(TRACKER_APPS_CFLAGS)					\
+	$(GTK_CFLAGS)						\
 	$(TRACKER_APPLETS_CFLAGS)				\
 	$(GDKPIXBUF_CFLAGS)					\
 	$(WARN_CFLAGS)						\
@@ -27,6 +28,7 @@ tracker_search_bar_CFLAGS = \
 tracker_search_bar_LDADD = 					\
 	$(top_builddir)/src/libtracker-client/libtracker-client-@TRACKER_API_VERSION@.la \
 	$(TRACKER_APPS_LIBS)					\
+	$(GTK_LIBS)						\
 	$(TRACKER_APPLETS_LIBS)					\
 	$(GDKPIXBUF_LIBS)					\
 	$(GCOV_LIBS)
diff --git a/src/tracker-search-bar/tracker-aligned-window.c b/src/tracker-search-bar/tracker-aligned-window.c
index bcc7852..035db13 100644
--- a/src/tracker-search-bar/tracker-aligned-window.c
+++ b/src/tracker-search-bar/tracker-aligned-window.c
@@ -91,7 +91,7 @@ tracker_aligned_window_init (TrackerAlignedWindow *aligned_window)
 	priv->motion_id = 0;
   
 	/* set window properties */
-	window->type = GTK_WINDOW_TOPLEVEL;
+	// FIX: How to port it to Gtk 3.0: window->type = GTK_WINDOW_TOPLEVEL;
 
 	gtk_window_set_decorated (window, FALSE);
 	gtk_window_set_type_hint (window, GDK_WINDOW_TYPE_HINT_DOCK);
@@ -155,7 +155,7 @@ tracker_aligned_window_position (TrackerAlignedWindow *window)
 
 	gdk_flush ();
   
-	gdk_window_get_geometry (GTK_WIDGET (window)->window,
+	gdk_window_get_geometry (gtk_widget_get_window (GTK_WIDGET (window)),
 	                         NULL,
 	                         NULL,
 	                         &our_width,
@@ -171,10 +171,10 @@ tracker_aligned_window_position (TrackerAlignedWindow *window)
 	gtk_widget_realize (align_widget);
   
 	/* get the positional and dimensional attributes of the align widget */
-	gdk_window_get_origin (align_widget->window,
+	gdk_window_get_origin (gtk_widget_get_window (align_widget),
 	                       &entry_x,
 	                       &entry_y);
-	gdk_window_get_geometry (align_widget->window,
+	gdk_window_get_geometry (gtk_widget_get_window (align_widget),
 	                         NULL,
 	                         NULL,
 	                         &entry_width,
@@ -235,14 +235,14 @@ tracker_aligned_window_motion_notify_cb (GtkWidget            *widget,
 	GtkAllocation alloc;
 	GdkRectangle rect;
 
-	alloc = GTK_WIDGET (aligned_window)->allocation;
+	gtk_widget_get_allocation (GTK_WIDGET (aligned_window), &alloc);
   
 	rect.x = 0;
 	rect.y = 0;
 	rect.width = alloc.width;
 	rect.height = alloc.height;
 
-	gdk_window_invalidate_rect (GTK_WIDGET (aligned_window)->window,
+	gdk_window_invalidate_rect (gtk_widget_get_window (GTK_WIDGET (aligned_window)),
 	                            &rect,
 	                            FALSE);
   
diff --git a/src/tracker-search-bar/tracker-applet.c b/src/tracker-search-bar/tracker-applet.c
index 7bae087..7bc892e 100644
--- a/src/tracker-search-bar/tracker-applet.c
+++ b/src/tracker-search-bar/tracker-applet.c
@@ -94,7 +94,7 @@ applet_entry_start_search (TrackerApplet *applet)
 		g_object_set (applet->results, "query", text, NULL);
 	}
 
-	if (!GTK_WIDGET_VISIBLE (applet->results)) {
+	if (!gtk_widget_get_visible (applet->results)) {
 		tracker_results_window_popup (TRACKER_RESULTS_WINDOW (applet->results));
 	}
 }
@@ -249,21 +249,23 @@ applet_change_orient_cb (GtkWidget         *widget,
 {
 	TrackerApplet *applet;
 	guint new_size;
+	GtkAllocation alloc;
 
 	applet = user_data;
         new_size = applet->size;
+	gtk_widget_get_allocation (GTK_WIDGET (applet->parent), &alloc);
 
 	switch (orient) {
 	case PANEL_APPLET_ORIENT_LEFT:
 	case PANEL_APPLET_ORIENT_RIGHT:
 		applet->orient = GTK_ORIENTATION_VERTICAL;
-		new_size = GTK_WIDGET (applet->parent)->allocation.width;
+		new_size = alloc.width;
 		break;
 
 	case PANEL_APPLET_ORIENT_UP:
 	case PANEL_APPLET_ORIENT_DOWN:
 		applet->orient = GTK_ORIENTATION_HORIZONTAL;
-		new_size = GTK_WIDGET (applet->parent)->allocation.height;
+		new_size = alloc.height;
 		break;
 	}
 
diff --git a/src/tracker-search-bar/tracker-results-window.c b/src/tracker-search-bar/tracker-results-window.c
index 7690a82..9ac0ec9 100644
--- a/src/tracker-search-bar/tracker-results-window.c
+++ b/src/tracker-search-bar/tracker-results-window.c
@@ -527,8 +527,12 @@ static gboolean
 results_window_button_press_event (GtkWidget      *widget,
                                    GdkEventButton *event)
 {
-	if (event->x < 0 || event->x > widget->allocation.width ||
-	    event->y < 0 || event->y > widget->allocation.height) {
+	GtkAllocation alloc;
+
+	gtk_widget_get_allocation (widget, &alloc);
+
+	if (event->x < 0 || event->x > alloc.width ||
+	    event->y < 0 || event->y > alloc.height) {
 		/* Click happened outside window, pop it down */
 		gtk_widget_hide (widget);
 		return TRUE;
@@ -549,20 +553,20 @@ results_window_size_request (GtkWidget      *widget,
 	GtkRequisition child_req;
 	guint border_width;
 
-	gtk_widget_size_request (GTK_BIN (widget)->child, &child_req);
+	gtk_widget_size_request (gtk_bin_get_child(GTK_BIN (widget)), &child_req);
 	border_width = gtk_container_get_border_width (GTK_CONTAINER (widget));
 
 	requisition->width = child_req.width + (2 * border_width);
 	requisition->height = child_req.height + (2 * border_width);
 
-	if (GTK_WIDGET_REALIZED (widget)) {
+	if (gtk_widget_get_realized (widget)) {
 		GdkScreen *screen;
 		GdkRectangle monitor_geom;
 		guint monitor_num;
 
 		/* make it no larger than half the monitor size */
 		screen = gtk_widget_get_screen (widget);
-		monitor_num = gdk_screen_get_monitor_at_window (screen, widget->window);
+		monitor_num = gdk_screen_get_monitor_at_window (screen, gtk_widget_get_window (widget));
 
 		gdk_screen_get_monitor_geometry (screen, monitor_num, &monitor_geom);
 
@@ -1387,14 +1391,14 @@ grab_popup_window (TrackerResultsWindow *window)
 	priv = TRACKER_RESULTS_WINDOW_GET_PRIVATE (window);
 
 	/* Grab pointer */
-	status = gdk_pointer_grab (widget->window,
+	status = gdk_pointer_grab (gtk_widget_get_window (widget),
 	                           TRUE,
 	                           GDK_POINTER_MOTION_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK,
 	                           NULL, NULL,
 	                           time);
 
 	if (status == GDK_GRAB_SUCCESS) {
-		status = gdk_keyboard_grab (widget->window, TRUE, time);
+		status = gdk_keyboard_grab (gtk_widget_get_window (widget), TRUE, time);
 	}
 
 	if (status == GDK_GRAB_SUCCESS) {
@@ -1434,10 +1438,10 @@ tracker_results_window_popup (TrackerResultsWindow *window)
 
         /* Force scroll to top-left */
         vadj = gtk_scrolled_window_get_vadjustment (GTK_SCROLLED_WINDOW (priv->scrolled_window));
-        gtk_adjustment_set_value (vadj, vadj->lower);
+        gtk_adjustment_set_value (vadj, gtk_adjustment_get_lower (vadj));
 
         hadj = gtk_scrolled_window_get_hadjustment (GTK_SCROLLED_WINDOW (priv->scrolled_window));
-        gtk_adjustment_set_value (hadj, hadj->lower);
+        gtk_adjustment_set_value (hadj, gtk_adjustment_get_lower (hadj));
 
         g_idle_add ((GSourceFunc) grab_popup_window, window);
 }
diff --git a/src/tracker-status-icon/Makefile.am b/src/tracker-status-icon/Makefile.am
index 797cbc9..1d4eaa6 100644
--- a/src/tracker-status-icon/Makefile.am
+++ b/src/tracker-status-icon/Makefile.am
@@ -10,6 +10,7 @@ INCLUDES =								\
 	-I$(top_builddir)/src						\
 	-I$(top_builddir)/src/libtracker-client				\
 	$(TRACKER_APPS_CFLAGS)						\
+	$(GTK_CFLAGS)							\
 	$(PANGO_CFLAGS)							\
 	$(WARN_CFLAGS)							\
 	$(GCOV_CFLAGS)
@@ -22,6 +23,7 @@ tracker_status_icon_LDADD = 						\
 	$(top_builddir)/src/libtracker-client/libtracker-client-@TRACKER_API_VERSION@.la \
 	$(top_builddir)/src/libtracker-common/libtracker-common.la 	\
 	$(TRACKER_APPS_LIBS)						\
+	$(GTK_LIBS)							\
 	$(PANGO_LIBS)							\
 	$(GCOV_LIBS)							\
 	-lX11
diff --git a/src/tracker-writeback/Makefile.am b/src/tracker-writeback/Makefile.am
index 76e37c3..ef12095 100644
--- a/src/tracker-writeback/Makefile.am
+++ b/src/tracker-writeback/Makefile.am
@@ -13,6 +13,7 @@ INCLUDES = 								\
 	-I$(top_builddir)/src						\
 	-I$(top_builddir)/src/libtracker-client				\
 	$(TRACKER_APPS_CFLAGS)						\
+	$(GTK_CFLAGS)							\
 	$(WARN_CFLAGS)							\
 	$(GLIB2_CFLAGS)							\
 	$(GCOV_CFLAGS)							\
@@ -77,6 +78,7 @@ tracker_writeback_LDADD = 						\
 	$(top_builddir)/src/libtracker-miner/libtracker-miner-@TRACKER_API_VERSION@.la 	\
 	$(top_builddir)/src/libtracker-common/libtracker-common.la	\
 	$(TRACKER_APPS_LIBS)						\
+	$(GTK_LIBS)							\
 	$(DBUS_LIBS)							\
 	$(GMODULE_LIBS)							\
 	$(GTHREAD_LIBS)							\
-- 
1.7.1.1

